document.addEventListener('DOMContentLoaded', function() {
    let currentSaleIndex = 0;
    let salesData = [];
    let filteredSalesData = [];

    function formatDate(dateTime) {
        const date = new Date(dateTime);
        return date.toLocaleDateString();
    }

    function formatTime(dateTime) {
        const date = new Date(dateTime);
        return date.toLocaleTimeString();
    }

    function updateSalesDisplay() {
        if (salesData.length === 0) return;

        const sale = salesData[currentSaleIndex];
        const leadIdContainer = document.getElementById('lead-id-container');
        const salesOutcomesContainer = document.getElementById('sales-outcomes-container');
        const customerInfoContainer = document.getElementById('customer-info-container');
        const counter = document.getElementById('counter');

        if (leadIdContainer) {
            leadIdContainer.textContent = `Lead ID: ${sale.accountNumber || 'N/A'}`;
        }

        if (salesOutcomesContainer) {
            salesOutcomesContainer.innerHTML = `
                <div class="sales-history-item">
                    <div class="details">
                        <p>Sale: ${sale.saleType}</p>
                        <p>Notes: ${sale.notesValue || 'No notes'}</p>
                    </div>
                    <div class="date-time">
                        <span>${formatDate(sale.outcomeTime)}</span>
                        <span>${formatTime(sale.outcomeTime)}</span>
                    </div>
                </div>
            `;
        }

        if (customerInfoContainer) {
            const customerInfoHtml = displayCustomerInfo(sale.customerInfo);
            customerInfoContainer.innerHTML = customerInfoHtml;
        }

        if (counter) {
            counter.textContent = `${currentSaleIndex + 1} of ${salesData.length}`;
        }
    }

    function displayCustomerInfo(customerInfo) {
        if (!customerInfo) {
            return '<p>No customer information available.</p>';
        }
        const name = `${customerInfo.firstName || ''} ${customerInfo.lastName || ''}`.trim() || 'N/A';
        return `
            <div class="customer-info">
                <p>Name: ${name}</p>
                <p>Email: ${customerInfo.email || 'N/A'}</p>
                <p>Phone: ${customerInfo.phone || 'N/A'}</p>
            </div>
        `;
    }

    function loadProcessedSalesData(user) {
        const database = firebase.database();
        const salesCountsRef = database.ref('salesCounts/' + user.uid);

        salesCountsRef.once('value', snapshot => {
            const data = snapshot.val();
            if (data) {
                salesData = Object.values(data).flatMap(dayData => Object.values(dayData));
                salesData.sort((a, b) => new Date(b.outcomeTime) - new Date(a.outcomeTime));
                filteredSalesData = [];
                currentSaleIndex = 0;
                updateSalesDisplay();
            } else {
                console.log('No processed sales data found.');
            }
        }).catch(error => {
            console.error('Error fetching processed sales data:', error);
        });
    }

    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            loadProcessedSalesData(user);
        } else {
            console.log('No user is signed in.');
        }
    });

    document.getElementById('prev').addEventListener('click', function() {
        if (currentSaleIndex > 0) {
            currentSaleIndex--;
            updateSalesDisplay();
        }
    });

    document.getElementById('next').addEventListener('click', function() {
        if (currentSaleIndex < salesData.length - 1) {
            currentSaleIndex++;
            updateSalesDisplay();
        }
    });

    const searchInput = document.getElementById('searchById');
    const clearSearchButton = document.getElementById('clearSearch');

    searchInput.addEventListener('input', function() {
        const query = searchInput.value.trim().toLowerCase();
        if (query) {
            clearSearchButton.style.display = 'inline';
            filteredSalesData = salesData.filter(sale => sale.accountNumber.toLowerCase().includes(query));
        } else {
            clearSearchButton.style.display = 'none';
            filteredSalesData = [];
        }
        currentSaleIndex = 0;
        updateSalesDisplay();
    });

    clearSearchButton.addEventListener('click', function() {
        searchInput.value = '';
        clearSearchButton.style.display = 'none';
        filteredSalesData = [];
        currentSaleIndex = 0;
        updateSalesDisplay();
    });
});