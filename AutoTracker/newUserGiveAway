// userInitialization.js

function initializeNewUser(userId) {
    const database = firebase.database();
    const userRef = database.ref('users/' + userId);
    const pointsRef = database.ref('points/' + userId);

    userRef.once('value', snapshot => {
        if (!snapshot.exists()) {
            // This is a new user
            userRef.set({
                joinDate: firebase.database.ServerValue.TIMESTAMP,
                initialPointsGiven: true
            }).then(() => {
                return pointsRef.set(100);
            }).then(() => {
                showWelcomePopup();
            }).catch(error => {
                console.error("Error setting initial user data:", error);
            });
        } else {
            // Existing user, check if they have points
            pointsRef.once('value', pointsSnapshot => {
                if (!pointsSnapshot.exists()) {
                    // User exists but doesn't have points, give them 100
                    pointsRef.set(100).then(() => {
                        userRef.update({ initialPointsGiven: true });
                        showWelcomePopup();
                    }).catch(error => {
                        console.error("Error setting initial points:", error);
                    });
                }
            });
        }
    });
}

function showWelcomePopup() {
    const popupHtml = `
        <div id="welcomePopup" class="popup">
            <div class="popup-content">
                <h2>Welcome to the site!</h2>
                <p>Thank you for joining! Here's 100 points to get you started!</p>
                <p>These can be redeemed for a variety of things in the near future, so keep stacking these!</p>
                <button id="closePopup">Got it!</button>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', popupHtml);
    const popup = document.getElementById('welcomePopup');
    popup.style.display = 'block';  // Make sure the popup is visible

    const closeButton = document.getElementById('closePopup');
    closeButton.addEventListener('click', () => {
        popup.style.display = 'none';
    });
}

// Listen for auth state changes
firebase.auth().onAuthStateChanged(user => {
    if (user) {
        initializeNewUser(user.uid);
    }
});