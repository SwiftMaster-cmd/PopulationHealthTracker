import { database } from './firebase-init.js';
import { ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-database.js";
import { drawWheel, saveNodesConfiguration, shuffleNodes } from './wheel.js';

let currentNodes = [];
let currentRotation = 0;

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('save-preset-button').addEventListener('click', savePreset);
    loadPresets();
});

function savePreset() {
    const presetName = document.getElementById('preset-name').value;
    if (!presetName) {
        alert('Please enter a preset name.');
        return;
    }

    const preset = { nodes: currentNodes };

    const presetsRef = ref(database, `spinTheWheelPresets/${presetName}`);
    set(presetsRef, preset).then(() => {
        alert('Preset saved successfully.');
        loadPresets(); // Refresh the presets list after saving
    }).catch((error) => {
        console.error('Error saving preset:', error);
    });
}


function loadPresets() {
    const presetsRef = ref(database, 'spinTheWheelPresets');
    onValue(presetsRef, (snapshot) => {
        const data = snapshot.val();
        const presets = data ? Object.entries(data).map(([key, value]) => ({ name: key, nodes: value.nodes })) : [];
        displayPresets(presets);
    });
}
// Function to load a preset configuration
function loadPreset(preset) {
    const container = document.getElementById('nodes-container');
    container.innerHTML = ''; // Clear current nodes

    preset.nodes.forEach(nodeValue => {
        const nodeElement = document.createElement('input');
        nodeElement.type = 'text';
        nodeElement.value = nodeValue;
        container.appendChild(nodeElement);
    });

    // Update the current configuration to match the preset
    selectedConfiguration = preset;
}

// Event listener for selecting a preset
document.getElementById('preset-select').addEventListener('change', (event) => {
    const presetName = event.target.value;
    const preset = getPresetByName(presetName);
    loadPreset(preset);
});

// Function to get preset by name
function getPresetByName(name) {
    // Assuming presets is an array of preset objects
    return presets.find(preset => preset.name === name);
}


export function loadPresetConfiguration(presetName, callback) {
    const db = getDatabase();
    const presetRef = ref(db, `presets/${presetName}`);
    get(presetRef).then((snapshot) => {
        const preset = snapshot.val();
        callback(preset.nodes);
    });
}

function displayPresets(presets) {
    const presetsContainer = document.getElementById('presets-container');
    presetsContainer.innerHTML = '';

    const presetsPerPage = 5;
    const currentPage = 0;

    const start = currentPage * presetsPerPage;
    const end = Math.min(start + presetsPerPage, presets.length);

    for (let i = start; i < end; i++) {
        const preset = presets[i];
        const presetButton = document.createElement('button');
        presetButton.textContent = preset.name;
        presetButton.addEventListener('click', () => displayPresetSummary(preset));
        presetsContainer.appendChild(presetButton);
    }

    document.getElementById('prev-button').disabled = currentPage === 0;
    document.getElementById('next-button').disabled = end >= presets.length;
}

function displayPresetSummary(preset) {
    const summaryText = document.getElementById('summary-text');
    summaryText.textContent = `Preset: ${preset.name}`;

    const nodes = preset.nodes;
    console.log('Preset nodes:', nodes); // Debugging
    currentNodes = nodes;
    currentRotation = 0; // Reset rotation to zero when loading a new preset
    const shuffledNodes = shuffleNodes(currentNodes); // Automatically shuffle nodes
    drawWheel(shuffledNodes, currentRotation);
    drawCurrentConfiguration(shuffledNodes);
    saveNodesConfiguration(shuffledNodes); // Save the shuffled nodes configuration to Firebase
}

function drawCurrentConfiguration(nodes) {
    const currentNodesContainer = document.getElementById('current-nodes-container');
    currentNodesContainer.innerHTML = ''; // Clear existing nodes

    nodes.forEach(node => {
        const nodeElement = document.createElement('div');
        nodeElement.textContent = `Value: ${node.value}, Count: ${node.count}`;
        currentNodesContainer.appendChild(nodeElement);
    });
}
